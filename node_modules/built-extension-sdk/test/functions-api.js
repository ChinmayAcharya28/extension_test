var ExtensionSDK = require('../index')

describe("For function calls", function() {
  var currentUser = {
    type     : 'ApplicationUser',
    authtoken: 'dummyToken',
    uid      : 'anonymous',
    email    : 'testUser@raweng.com'
  }
  // Mocks hooks register call
  beforeEach(function(){
    httpMock('https://api.built.io')
    .put('/v1/extensions/local1/hooks', {
      hooks: []
    })
    .reply(201)
  })

  describe('Successfully Execution', function() {
    it("should receive current user information in built context", function(done) {
      var api
      // Post hooks
      var testFunction = {
        '/v1/functions/testFunction': {
          POST: function(req, res){
            expect(req.built.getContextVar('currentUser')).to.be.deep.equal(currentUser)
            return utils.Promise.resolve()
          }
        }
      }
      // Adds routes to express server
      // Initialize SDK
      return startAPIServerWithHooks(testFunction)
      .then(function(server) {
        server.api.post('/api/v1/functions/testFunction')
        .set('application_api_key', 'dummy_api_key')
        .expect(200)
        .send({
          data         : {'name': 'abc'},
          class_uid    : 'person',
          authtoken    : 'dummyToken',
          event        : 'POST',
          current_user : currentUser
        })
        .end(function(err, res) {
          // expect(res.body.data.name).to.be.equal('changed')
          return server.extensionSDK.stop()
          .then(function(){
            done()
          })
        })
      })
    })
    it("should receive request payload", function(done) {
      var api
      var data = {
        'name': 'abc'
      }
      // Post hooks
      var testFunction = {
        '/v1/functions/testFunction': {
          POST: function(req, res){
            expect(req.payload.data).to.be.deep.equal(data)
            return utils.Promise.resolve()
          }
        }
      }
      // Adds routes to express server
      // Initialize SDK
      return startAPIServerWithHooks(testFunction)
      .then(function(server) {
        server.api.post('/api/v1/functions/testFunction')
        .set('application_api_key', 'dummy_api_key')
        .expect(200)
        .send({
          data         : data,
          class_uid    : 'person',
          authtoken    : 'dummyToken',
          event        : 'POST',
          current_user : currentUser
        })
        .end(function(err, res) {
          // expect(res.body.data.name).to.be.equal('changed')
          return server.extensionSDK.stop()
          .then(function(){
            done()
          })
        })
      })
    })
    it("should receive application_api_key in headers", function(done){
      var api
      var data = {
        'name': 'abc'
      }
      // Post hooks
      var testFunction = {
        '/v1/functions/testFunction': {
          POST: function(req, res){
            expect(req.headers['application_api_key']).to.be.equal('dummy_api_key')
            return utils.Promise.resolve()
          }
        }
      }
      // Adds routes to express server
      // Initialize SDK
      return startAPIServerWithHooks(testFunction)
      .then(function(server) {
        server.api.post('/api/v1/functions/testFunction')
        .set('application_api_key', 'dummy_api_key')
        .expect(200)
        .send({
          data         : data,
          class_uid    : 'person',
          authtoken    : 'dummyToken',
          event        : 'POST',
          current_user : currentUser
        })
        .end(function(err, res) {
          // expect(res.body.data.name).to.be.equal('changed')
          return server.extensionSDK.stop()
          .then(function(){
            done()
          })
        })
      })
    })
    it("should receive the response send by extension function", function(done){
      var data = {
        'name': 'abc'
      }
      // Post hooks
      var testFunction = {
        '/v1/functions/testFunction': {
          POST: function(req, res){
            this.resSuccess(req, res, {
              key: "value"
            })
          }
        }
      }
      // Adds routes to express server
      // Initialize SDK
      return startAPIServerWithHooks(testFunction)
      .then(function(server) {
        server.api.post('/api/v1/functions/testFunction')
        .set('application_api_key', 'dummy_api_key')
        .expect(200)
        .send({
          data         : data,
          class_uid    : 'person',
          authtoken    : 'dummyToken',
          event        : 'POST',
          current_user : currentUser
        })
        .end(function(err, res) {
          expect(res.body).to.be.deep.equal({
            isExtensionResponse: true,
            data : {
              key: "value"
            }
          })
          return server.extensionSDK.stop()
          .then(function(){
            done()
          })
        })
      })  
    })
  })
  describe("Under Error conditions", function () {
    it("should receive the error response send by the extension function", function(done){
      var data = {
        'name': 'abc'
      }
      // Post hooks
      var testFunction = {
        '/v1/functions/testFunction': {
          POST: function(req, res){
            this.resError(req, res, {
                name: "is mandatory field"
            })
          }
        }
      }
      // Adds routes to express server
      // Initialize SDK
      return startAPIServerWithHooks(testFunction)
      .then(function(server) {
        server.api.post('/api/v1/functions/testFunction')
        .set('application_api_key', 'dummy_api_key')
        .expect(422)
        .send({
          data         : data,
          class_uid    : 'person',
          authtoken    : 'dummyToken',
          event        : 'POST',
          current_user : currentUser
        })
        .end(function(err, res) {
          expect(res.body).to.be.deep.equal({
            isExtensionError: true,
            errors : [{
              errorKey: "is mandatory field",
              path: "name"
            }]
          })
          return server.extensionSDK.stop()
          .then(function(){
            done()
          })
        })
      })    
    })
  })
})